name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout full history for Nx affected
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup PNPM v10 (adds pnpm to PATH)
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      # 3. Setup Node.js and enable pnpm caching
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 4. Debug step: confirm pnpm is available and pnpm-workspace.yaml exists
      - name: Debug pnpm setup
        run: |
          which pnpm
          pnpm --version
          echo "Current directory: $(pwd)"
          ls -la
          cat pnpm-workspace.yaml || echo "pnpm-workspace.yaml not found"

      # 5. Set Nx SHAs for affected commands
      - uses: nrwl/nx-set-shas@v4

      # 6. Install dependencies
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 7. Generate Prisma client before any backend build
      - name: Generate Prisma client
        run: pnpm prisma:generate

      # 8. Install Cypress binary
      - run: pnpm exec cypress install

      # 9. Start Nx Cloud distributed agents (optional, if using Nx Cloud)
      - run: pnpm dlx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="e2e-ci"

      # 10. Run lint in parallel
      - run: pnpm exec nx affected -t lint --parallel=3

      # 11. Run tests in parallel
      - run: pnpm exec nx affected -t test --parallel=3 --configuration=ci

      # 12. Run build in parallel
      - run: |
          # Ensure Prisma generation is completed for all affected backend projects
          pnpm exec nx run-many --target=generate --projects=prisma --parallel
          # Then build all affected projects
          pnpm exec nx affected -t build --parallel=3

      # 13. Run e2e tests in parallel
      - run: pnpm exec nx affected -t e2e --parallel=3 --configuration=ci
        env:
          CI: true
